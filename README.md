# HistologyTrialModule
Custom 3D Slicer module that automates hematoxylin and eosin stain separation of histology images.
It is designed to improve the visualization of histology stain separation by providing simultaneous views of the original image, hematoxylin channels, and eosin channels in each of Slicer's viewers. It also contains a basic customized VGG16 binary classification model that provides a prediction for IBD as Crohn's disease (CD) or ulcerative colitis (UC).

## Installation
To download the module extension, download and extract the zip file HistologyTrialModule. Main code for execution is in HistologyTrialModule.py. The VGG16 model can be downloaded as [VGG16_binary_classification.keras](https://drive.google.com/file/d/1YerdQOhAOrnXdQzWJaEP87zPdjPTt_ku/view?usp=sharing). Move it into the Resources folder in HistologyTrialModule and it will be called upon in the Pycharm file to run binary classification of input data.

## Usage
The module accepts a volumetric stack of histology images. To properly utilize the model, whole slide images (WSIs) are cropped and resized to the same size and stacked to create a 3D volumetric array of size = (depth, height, width) where depth = the number of slices/images in the stack. Preprocessing code for this step can be found in [Hematoxylin Images for Model.ipynb](https://github.com/20as179/881-Pediatric-IBD-Histopathology-Analysis/blob/main/Hematoxylin%20Images%20for%20Model.ipynb). A [sample volume](https://drive.google.com/file/d/1KhF3KRhtNAKNdXS7m7UE0ab6FIQdtID_/view?usp=sharing) has been provided and contains preprocessing of a full set of histology images from the Childrenâ€™s Hospital of Orange County (CHOC) Research Institute of a pediatric patient with IBD. Upon loading into 3D Slicer, navigate to the HistologyTrialModule extension and click apply to transform the model into its separate hematoxylin and eosin staining channels.

## Training
### WSI Preprocessing
The notebook Hematoxylin Images for Model.ipynb focuses on cropping the raw images (.jpgs) into 1000x1000 pixel fields such that outer borders of whitespace (noise) are removed. Images must be of the same size in order to be stacked, and dimensions less than 1000 pixels are filled in with empty values. The volumes are saved as .nrrd files and stored under each patient's directory as an output volume. It also performs hematoxylin and eosin stain separation and saves the isolated hematoxylin channels as .jpgs for further processing.

### VGG16 Model Training
Training is located in [Labelling Images with IBD Subtype.ipynb](https://github.com/20as179/881-Pediatric-IBD-Histopathology-Analysis/blob/main/Labelling%20Images%20with%20IBD%20Subtype.ipynb). VGG16 accepts inputs of 224x224, so each slice of an input is iteratively downsized to match requirements. Data augmentation makes further adjustments to the images using ImageDataGenerator. For customized data augmentation, these parameters can be adjusted according to the user's wishes for diverse results. The model was pretrained using ImageNet weights and its layers have been customized based on other histology classification models using VGG16 as a baseline. The customized layers are adjusted to account for binary classification of histology images. The model uses weakly supervised training of pediatric IBD data from 18 patients (951 individual slides in total) with each slide classified as UC or CD depending on the patient's overall diagnosis. The baseline model prior to customization can be found [here](https://www.kaggle.com/code/ghitabenjrinija/medical-image-analysis-with-cnn).

In 3D Slicer, the output for "Diagnosis" will either be UC or CD based on the average of predictive scores for the full stack of slices.
